name: ESP-IDF Build
on: [push]

jobs:
  build-solaris-code:
    runs-on: self-hosted

    container:
      image: espressif/idf:v6.0-dev
      # Importante en Fedora/SELinux para que el contenedor pueda escribir en /__w
      options: >-
        --security-opt label=disable
        --volume /__w:/__w:Z
        --volume /__e:/__e:Z

    steps:
      # (Opcional) Por si tu runner creó /__w muy restrictivo
      - name: Fix permissions for GitHub workspace
        run: |
          chmod -R 777 "$GITHUB_WORKSPACE" || true
          chmod -R 777 /__w || true

      - name: Checkout (repo + submodules con token)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.CI_GH_TOKEN }}

      # Refuerza URLs de submódulos y clonado anidado
      - name: Sync & init submodules (refuerzo)
        run: |
          git submodule sync --recursive
          git submodule update --init --recursive

      # Herramientas que a veces faltan en la imagen
      - name: Ensure git & ssh client
        run: |
          apt-get update
          apt-get install -y git openssh-client
          rm -rf /var/lib/apt/lists/*

      - name: Build firmware
        run: |
          cd solaris-v0.2
          . /opt/esp/idf/export.sh
          idf.py build
